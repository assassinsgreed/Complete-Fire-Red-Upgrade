import glob
from subprocess import call

ERROR_COLOR = "\033[1;31m"
ROM_NAME = 'BPRE0.gba'

def main():
    """ Load all .ips patches from patches subdirectory and apply them """
    for file in glob.glob(".\\automation\\patches\\*.ips"):
        result = call(["python", ".\\automation\\ips.py", file, ROM_NAME])
        if (result != 0):
            print(ERROR_COLOR + "Error applying patch: {}. See output for details. Exiting with status code: 1".format(file))
            exit(1)

        # If the patch is the BW Music patch, we need to apply additional logic
        if "B2W2 Music Patch" in file: ApplyBWMusicPatch()

    # Apply binary fixes and hacks that we don't want to permanently have in the game
    with open(ROM_NAME, 'rb+') as romfile:
        # Fix bug in scrolling multichoice windows
        romfile.seek(0xCBB84)
        romfile.write(b'\x00\x00\x00\x00')
        
        # Disable the opening cutscene
        romfile.seek(0xEC5D0)
        romfile.write(b'\x15\x89\x07')

        # Replace the normal grass shaking animation with one that has transparency, to work on grass tiles in maps with special grass (eg. snowy)
        romfile.seek(0x39A008)
        romfile.write(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3E\x43\x44\xE0\xD3\xED\x34\x30\xDD\x3E\x33\x3E\x44\x44\xEE\xEE\x33\x33\xE4\x00\xEE\x33\x43\x00\x00\x00\x00\x00\x00\x00\x00\x44\x44\x34\x00\x44\xE3\x4E\x0E\x43\x33\xE3\xE4\x3E\x44\x44\x34\x43\x33\x33\x33\x34\x33\xEE\x00\x00\xE0\x00\x00\xE0\x00\x00\x00\x00\x00\x0E\xE0\x00\x00\x00\x3E\x00\x33\xE3\xCE\xF0\xCC\x3D\xD3\x00\xDF\xED\xE3\xF0\xFF\xE3\x3E\x00\x00\x0E\x00\x00\x00\x00\xE0\x03\xE0\x00\x00\x3C\x00\x00\x00\x3D\x4E\x43\x00\x3E\xD4\xCC\x04\x4E\xEE\x4E\x03\x3E\x33\x44\xE3\xCE\xCC\x3E\x3E\x33\xED\xEE\x33\x30\x43\x44\x34\xE0\x33\x33\x44\x30\xED\x3E\x33\x3E\x3E\x44\xEE\x4E\x44\x33\xE4\x00\xEE\x33\x43\x33\xE4\xDD\xED\x44\x33\xEE\x43\x34\x44\x44\x33\x44\x33\x43\x0E\x43\xE3\xEE\xE4\x33\x44\xE3\x34\x43\x33\x44\x34\x34\x33\xEE\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x01\x00\x00\x10\x11\x00\x00\xF0\x11\x3D\xD3\x00\xDF\xED\xE3\xF0\xFF\xE3\x11\xCE\xCC\x3E\x11\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3E\x14\xC1\x04\x4E\x11\x41\x03\x3E\x11\x44\xE3\x33\xE4\xDD\xED\x13\xE1\xEE\x13\x10\x11\x44\x14\x00\x11\x43\x44\xE0\xD3\xED\x34\x30\xDD\x3E\x33\x3E\x44\x44\xEE\xEE\x33\x33\xE4\x00\xEE\x33\x43\x41\x33\x1E\x41\x31\x44\x11\x31\x44\x44\x11\x00\x44\xE3\x4E\x0E\x43\x33\xE3\xE4\x3E\x44\x44\x34\x43\x33\x33\x33\x34\x33\xEE\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x11\x01\x00\x00\x10\x11\x00\xCE\xCC\x3E\x3E\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x33\x11\xD1\xED\x33\xED\xEE\x33\x30\x43\x44\x34\x10\x11\x43\x44\xE0\x11\xE1\x34\x30\xDD\x3E\x33\x3E\x44\x44\xEE\xEE\x33\x33\xE4\x00\xEE\x33\x43\x14\x11\xEE\x43\x34\x44\x44\x33\x44\x33\x34\x00\x44\xE3\x11\x01\x43\x13\x11\xE4\x3E\x44\x44\x34\x43\x33\x33\x33\x34\x33\xEE\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0C\x00\x00\xC0\x0C\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xCC\x00\x00\x00\x00\x00\x00\x00\xCE\x43\x44\xE0\xCC\xED\x34\xC0\xDC\x3E\x33\x3E\x44\x44\xEE\xEE\x33\x33\xE4\x00\xEE\x33\x43\x00\x00\x00\x00\xC0\x00\x00\x00\xC4\x4C\x34\x00\x44\xCC\x4E\x0E\x43\x33\xE3\xE4\x3E\x44\x44\x34\x43\x33\x33\x33\x34\x33\xEE\x00\x00')

        romfile.close()

def ApplyBWMusicPatch():
    # Open BW/B2W2 Music Patch hex
    with open(".\\automation\\B2W2 Music Patch v1.4.1b.bit", 'rb') as musicpatch:
        bytes = bytearray(musicpatch.read())
        musicpatch.close()

    with open(ROM_NAME, 'rb+') as romfile:
        romfile.seek(0x1200000)
        romfile.write(bytes)

        # Update bytes recommended by CFRU docs
        romfile.seek(0x4A32A0)
        romfile.write(b'\xA0\xFA\x03\x02')

        # Set obtained Item fanfare duration to 0s, to avoid awkward silence when learning a new move. This is to bypass a problem with the music patch
        romfile.seek(0x3AC992)
        romfile.write(b'\x00\x00')
        
        romfile.close()

if __name__ == '__main__':
    main()
